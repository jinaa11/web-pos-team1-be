<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BranchAdminManagerController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webpos</a> &gt; <a href="index.source.html" class="el_package">com.ssg.webpos.controller.admin</a> &gt; <span class="el_source">BranchAdminManagerController.java</span></div><h1>BranchAdminManagerController.java</h1><pre class="source lang-java linenums">package com.ssg.webpos.controller.admin;

import com.ssg.webpos.domain.Order;
import com.ssg.webpos.domain.SettlementDay;
import com.ssg.webpos.domain.SettlementMonth;
import com.ssg.webpos.dto.settlement.*;
import com.ssg.webpos.repository.settlement.SettlementDayRepository;
import com.ssg.webpos.repository.settlement.SettlementMonthRepository;
import com.ssg.webpos.service.OrderService;
import com.ssg.webpos.service.SettlementDayService;
import com.ssg.webpos.service.SettlementMonthService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;


import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeParseException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Iterator;
import java.util.List;
import java.util.stream.Collectors;



@RestController
@RequestMapping(&quot;/api/v1/manager&quot;) // 팀장님한테 점장 로그인 구현 기능 받으면 manager에서 branchadmin-manager로 변경
<span class="nc" id="L32">@Slf4j</span>
<span class="nc" id="L33">@RequiredArgsConstructor</span>
public class BranchAdminManagerController {
    // manager 기능 : 재고 조회, 수정, 삭제, 재고 리포트(주말 재고 현황) 제출
    //               정산 조회, 정산 내역 리포트(일별, 월별 정산내역) 제출
    // 리포트가 이미 제출된 경우 버튼을 비활성화
    private final SettlementDayService settlementDayService;
    private final SettlementMonthService settlementMonthService;
    private final OrderService orderService;
    private final SettlementMonthRepository settlementMonthRepository;
    private final SettlementDayRepository settlementDayRepository;

    //일별정산내역 조회
    //RequestSettlementMonthDTO로 String 타입의 year(ex. &quot;2023&quot;)을 받으면 parse 활용해서 2023년도의 월별정산내역 조회
    // 받아오는 건 String으로 받아오고 스프링에서 startDate, endDate를 만들어서 레포지토리 매서드로 활용
    // 로그인 구현시 해당 store_id 만 나오도록 변경
    @PostMapping(&quot;/settlement-month&quot;)
    public List&lt;SettlementMonthReportDTO&gt; settlementMonth(@RequestBody RequsestSettlementMonthDTO requestSettlementMonthDTO) {
        try {
<span class="nc" id="L51">            String year = requestSettlementMonthDTO.getYear();</span>
<span class="nc" id="L52">            List&lt;SettlementMonth&gt; settlementMonths = settlementMonthService.selectByYear(year);</span>
<span class="nc" id="L53">            List&lt;SettlementMonthReportDTO&gt; reportDTOs = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L55" title="All 2 branches missed.">            for(SettlementMonth settlementMonth:settlementMonths) {</span>
<span class="nc" id="L56">                SettlementMonthReportDTO reportDTO = new SettlementMonthReportDTO();</span>
<span class="nc" id="L57">                reportDTO.setSettlementMontnId(settlementMonth.getId());</span>
<span class="nc" id="L58">                reportDTO.setSettlementPrice(settlementMonth.getSettlementPrice());</span>
<span class="nc" id="L59">                reportDTO.setSettlementDate(settlementMonth.getSettlementDate());</span>
<span class="nc" id="L60">                reportDTO.setStoreId(settlementMonth.getStore().getId());</span>
<span class="nc" id="L61">                reportDTO.setStoreName(settlementMonth.getStore().getName());</span>
<span class="nc" id="L62">                reportDTO.setCreatedDate(settlementMonth.getCreatedDate());</span>
<span class="nc" id="L63">                reportDTOs.add(reportDTO);</span>
<span class="nc" id="L64">            }</span>

<span class="nc" id="L66">            return reportDTOs;</span>
<span class="nc" id="L67">        } catch (Exception e) {</span>
<span class="nc" id="L68">            e.printStackTrace();</span>
<span class="nc" id="L69">            return Collections.emptyList();</span>
        }
    }

    //year 조회, 보이는 DTO : 입력한 year에 해당하는 settlement_month 정산내역
    //demo version

//    @PostMapping(&quot;/request-param/year/settlement-month&quot;)
//    public List&lt;SettlementMonthReportDTO&gt; settlementMonthByYear(@RequestBody RequestYearDTO requestYearDTO) {
//        try {
//            int yearValue = Integer.parseInt(requestYearDTO.getYear());
//            // order_date에 year가 있는 row를 조회
//            List&lt;SettlementMonth&gt; settlementMonths = settlementMonthRepository.findBySettlementDateContaining(String.valueOf(yearValue));
//
//            // 조회 결과를 DTO로 변환
//            List&lt;SettlementMonthReportDTO&gt; reportDTOList = settlementMonths.stream()
//                    .map(settlementMonth -&gt; new SettlementMonthReportDTO(settlementMonth))
//                    .collect(Collectors.toList());
//
//            return reportDTOList;
//        } catch (Exception e) {
//            // 예외 처리
//            e.printStackTrace();
//            // 빈 리스트 반환 또는 예외 처리에 따라 적절한 동작 수행
//            return Collections.emptyList();
//        }
//
//    }

    //조건을 명시한 상태에서 settlement_day 내역 GET (조건 : store_id=1L, settlement_date=&quot;2023-05-08&quot;)
    @GetMapping(&quot;/settlementDay-constant-date&quot;)
    public List&lt;SettlementDayReportDTO&gt; settlementDayByConstantDate() { //점장 로그인 기능 구현시 팀장님 코드 활용
//        팀장님 작성 BranchAdmin branchAdmin = principalDetail.getUser(); 이거 활용해서 로그인한 사람의 소속 가게 store_id불러올 수 있다.
//        팀장님 작성 Long storeId = branchAdmin.getStore().getId();
//        지금 해야하는 것 : 요청 받은 날짜의 결제 내역을 나오게 하는 것
<span class="nc" id="L104">        List&lt;SettlementDay&gt; settlementDays = settlementDayService.selectByStoreIdAndDay(1L,&quot;2023-05-08&quot;);</span>
<span class="nc" id="L105">        List&lt;SettlementDayReportDTO&gt; reportDTOs = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L107" title="All 2 branches missed.">        for (SettlementDay settlementDay : settlementDays) {</span>
<span class="nc" id="L108">            SettlementDayReportDTO reportDTO = new SettlementDayReportDTO();</span>
<span class="nc" id="L109">            reportDTO.setSettlementDayId(settlementDay.getId());</span>
<span class="nc" id="L110">            reportDTO.setSettlementPrice(settlementDay.getSettlementPrice());</span>
<span class="nc" id="L111">            reportDTO.setSettlementDate(settlementDay.getSettlementDate());</span>
<span class="nc" id="L112">            reportDTO.setStoreId(settlementDay.getStore().getId());</span>
<span class="nc" id="L113">            reportDTO.setStoreName(settlementDay.getStore().getName());</span>
<span class="nc" id="L114">            reportDTO.setCreatedDate(settlementDay.getCreatedDate());</span>
<span class="nc" id="L115">            reportDTOs.add(reportDTO);</span>
<span class="nc" id="L116">        }</span>

<span class="nc" id="L118">        return reportDTOs;</span>
    }

    // 일별 내역 조회
    // 날짜를 req 받는 상태에서 settlement_day 내역 GET
    // 예시 URL : http://localhost:8080/api/v1/manager/test2?settlementDate=2023-05-08
    // next level : 점장 로그인시 점장의 해당 store_id 정산내역 표시
    @GetMapping(&quot;/settlementDay-variable-date&quot;)
    public List&lt;SettlementDayReportDTO&gt; settlementDayByVariableDate(@RequestParam(&quot;settlementDate&quot;)String SettlementDate) throws DateTimeParseException {
        // 20022-05-08같이 테이블에 없는 날짜 내역이 올 경우 에러 -&gt; DateTimeParseException
        //
        try {
<span class="nc" id="L130">            List&lt;SettlementDay&gt; settlementDays = settlementDayService.selectByStoreIdAndDay(1L,SettlementDate);</span>
<span class="nc" id="L131">            List&lt;SettlementDayReportDTO&gt; reportDTOs = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L133" title="All 2 branches missed.">            for (SettlementDay settlementDay : settlementDays) {</span>
<span class="nc" id="L134">                SettlementDayReportDTO reportDTO = new SettlementDayReportDTO();</span>
<span class="nc" id="L135">                reportDTO.setSettlementDayId(settlementDay.getId());</span>
<span class="nc" id="L136">                reportDTO.setSettlementPrice(settlementDay.getSettlementPrice());</span>
<span class="nc" id="L137">                reportDTO.setSettlementDate(settlementDay.getSettlementDate());</span>
<span class="nc" id="L138">                reportDTO.setStoreId(settlementDay.getStore().getId());</span>
<span class="nc" id="L139">                reportDTO.setStoreName(settlementDay.getStore().getName());</span>
<span class="nc" id="L140">                reportDTO.setCreatedDate(settlementDay.getCreatedDate());</span>
<span class="nc" id="L141">                reportDTOs.add(reportDTO);</span>
<span class="nc" id="L142">            }</span>

<span class="nc" id="L144">            return reportDTOs;</span>
<span class="nc" id="L145">        } catch (Exception e) {</span>
<span class="nc" id="L146">            return Collections.emptyList();</span>
        }

    }

    // 특정 기간 일별 내역 조회
//    @GetMapping(&quot;/settlementDay-variable-range&quot;)
//    public List&lt;SettlementDayReportDTO&gt; settlementDayByVariableRange(@RequestParam(&quot;startDate&quot;) String startDate,
//                                              @RequestParam(&quot;endDate&quot;) String endDate) throws DateTimeParseException {
//        try {
//            List&lt;SettlementDay&gt; settlementDays = settlementDayService.selectByStoreIdAndDayBetween(1L,startDate,endDate);
//            List&lt;SettlementDayReportDTO&gt; reportDTOs = new ArrayList&lt;&gt;();
//
//            for (SettlementDay settlementDay : settlementDays) {
//                SettlementDayReportDTO reportDTO = new SettlementDayReportDTO();
//                reportDTO.setSettlementDayId(settlementDay.getId());
//                reportDTO.setSettlementPrice(settlementDay.getSettlementPrice());
//                reportDTO.setSettlementDate(settlementDay.getSettlementDate());
//                reportDTO.setStoreId(settlementDay.getStore().getId());
//                reportDTO.setStoreName(settlementDay.getStore().getName());
//                reportDTO.setCreatedDate(settlementDay.getCreatedDate());
//                reportDTOs.add(reportDTO);
//            }
//
//            return reportDTOs;
//        } catch (Exception e) {
//            return Collections.emptyList();
//        }
//    }

    // 월별 내역 조회
    // 날짜를 req 받는 상태에서 settlement_day 내역 GET
    // 예시 URL : http://localhost:8080/api/v1/manager/test3?settlementDate=2023-05-08
    // next level : 점장 로그인시 점장의 해당 store_id 정산내역 표시
//    @GetMapping(&quot;/settlementMonth-variable-date-yyyy-MM&quot;)
//    public List&lt;SettlementMonthReportDTO&gt; settlementMonthByVariableDateyyyyMM(@RequestParam(&quot;settlementDate&quot;)String SettlementDate) throws DateTimeParseException {
//        // 2테이블에 없는 날짜 내역이 올 경우 에러 -&gt; DateTimeParseException
//        // 기존 정산 내역에 있는 정산일자를 yyyy-MM 형식으로 바꾸고 storeName을 추가했습니다.
//        try {
//            List&lt;SettlementMonth&gt; settlementMonths = settlementMonthService.selectByStoreIdAndDay(1L,SettlementDate);
//            List&lt;SettlementMonthReportDTO&gt; reportDTOs = new ArrayList&lt;&gt;();
//
//            for (SettlementMonth settlementMonth : settlementMonths) {
//                SettlementMonthReportDTO reportDTO = new SettlementMonthReportDTO();
//                reportDTO.setSettlementMontnId(settlementMonth.getId());
//
//                reportDTO.setSettlementPrice(settlementMonth.getSettlementPrice());
//                // 월별 정산내역에서 settlementDate를 yyyy-MM-dd에서 yyyy-MM 형식으로 바꾸기 위한 과정 시작
//                LocalDate localDate = settlementMonth.getSettlementDate();
//                DateTimeFormatter dateTimeFormatter = DateTimeFormatter.ofPattern(&quot;yyyy-MM&quot;);
//                String formattDate = localDate.format(dateTimeFormatter);
//                // 월별 정산내역에서 settlementDate를 yyyy-MM-dd에서 yyyy-MM 형식으로 바꾸기 위한 과정 종료
//                reportDTO.setSettlementDate(formattDate);
//                reportDTO.setStoreId(settlementMonth.getStore().getId());
//                reportDTO.setStoreName(settlementMonth.getStore().getName());
//                reportDTO.setCreatedDate(settlementMonth.getCreatedDate());
//                reportDTOs.add(reportDTO);
//            }
//            return reportDTOs;
//        } catch (Exception e) {
//            return Collections.emptyList();
//        }
//    }
    // 특정 기간 월별 내역 조회
//    @GetMapping(&quot;/settlementMonth-variable-range-yyyy-MM&quot;)
//    public List&lt;SettlementMonthReportDTO&gt; settlementMonthByVariableRangeyyyyMM(@RequestParam(&quot;startDate&quot;)String startDate, @RequestParam(&quot;endDate&quot;)String endDate) throws DateTimeParseException {
//        try {
//            List&lt;SettlementMonth&gt; settlementMonths = settlementMonthService.selectByStoreIdAndDayBetween(1L, startDate,endDate);
//            List&lt;SettlementMonthReportDTO&gt; reportDTOs = new ArrayList&lt;&gt;();
//
//            for(SettlementMonth settlementMonth: settlementMonths) {
//                SettlementMonthReportDTO reportDTO = new SettlementMonthReportDTO();
//                reportDTO.setSettlementMontnId(settlementMonth.getId());
//                reportDTO.setSettlementPrice(settlementMonth.getSettlementPrice());
//                LocalDate localDate = settlementMonth.getSettlementDate();
//                DateTimeFormatter dateTimeFormatter = DateTimeFormatter.ofPattern(&quot;yyyy-MM&quot;);
//                String formattedDate = localDate.format(dateTimeFormatter);
//                reportDTO.setSettlementDate(formattedDate);
//                reportDTO.setStoreId(settlementMonth.getStore().getId());
//                reportDTO.setStoreName(settlementMonth.getStore().getName());
//                reportDTO.setCreatedDate(settlementMonth.getCreatedDate());
//                reportDTOs.add(reportDTO);
//            }
//            return reportDTOs;
//        } catch (Exception e) {
//            return Collections.emptyList();
//        }
//    }

    // 월별 기간 상세 조회
    // store_id, &quot;yyyy-mm&quot;
    @PostMapping(&quot;/settlement-month/detail&quot;)
    public ResponseEntity getDetailMonth(@RequestBody SettlementMonthDetailRequestDTO requestDTO) throws NullPointerException{
<span class="nc" id="L239">        Long store_id = requestDTO.getStoreId();</span>
<span class="nc" id="L240">        String date = requestDTO.getDate();</span>

<span class="nc" id="L242">        List&lt;Order&gt; orderList = orderService.selectByOrdersMonth(store_id,date);</span>
<span class="nc" id="L243">        Iterator&lt;Order&gt; iterator = orderList.iterator();</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">        while (iterator.hasNext()) {</span>
<span class="nc" id="L245">            Order order = iterator.next();</span>
<span class="nc" id="L246">            System.out.println(&quot;order = &quot; + order);</span>
<span class="nc" id="L247">        }</span>

<span class="nc" id="L249">        List&lt;SettlementMonthDetailResponseDTO&gt; responseDTOList = orderList.stream()</span>
<span class="nc" id="L250">                .map(order -&gt; new SettlementMonthDetailResponseDTO(order))</span>
<span class="nc" id="L251">                .collect(Collectors.toList());</span>
<span class="nc" id="L252">        return new ResponseEntity&lt;&gt;(responseDTOList, HttpStatus.OK);</span>
    }

    // 일별 기간 상세 조회
    // store_id, &quot;yyyy-mm-dd&quot;
    @PostMapping(&quot;/settlement-day/detail&quot;)
    public ResponseEntity getDetailDay(@RequestBody SettlementMonthDetailRequestDTO requestDTO) throws NullPointerException{
<span class="nc" id="L259">        Long store_id = requestDTO.getStoreId();</span>
<span class="nc" id="L260">        String date = requestDTO.getDate();</span>

<span class="nc" id="L262">        List&lt;Order&gt; orderList = orderService.selectByOrdersDay(store_id,date);</span>
<span class="nc" id="L263">        Iterator&lt;Order&gt; iterator = orderList.iterator();</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">        while (iterator.hasNext()) {</span>
<span class="nc" id="L265">            Order order = iterator.next();</span>
<span class="nc" id="L266">            System.out.println(&quot;order = &quot; + order);</span>
<span class="nc" id="L267">        }</span>

<span class="nc" id="L269">        List&lt;SettlementMonthDetailResponseDTO&gt; responseDTOList = orderList.stream()</span>
<span class="nc" id="L270">                .map(order -&gt; new SettlementMonthDetailResponseDTO(order))</span>
<span class="nc" id="L271">                .collect(Collectors.toList());</span>
<span class="nc" id="L272">        return new ResponseEntity&lt;&gt;(responseDTOList, HttpStatus.OK);</span>
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>